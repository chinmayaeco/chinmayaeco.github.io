<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Oligopoly Lab: Simulation â€¢ Case Studies â€¢ Managerial Implications</title>
  <style>
    :root{
      --bg:#0b1020; /* deep ink */
      --panel:#121734; /* card */
      --accent:#7dd3fc; /* cyan */
      --accent-2:#a78bfa; /* violet */
      --muted:#aab1c2; /* text muted */
      --text:#e8ecf3;
      --danger:#f87171;
      --success:#34d399;
      --warn:#fbbf24;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 18px;
    }
    html,body{height:100%;}
    body{
      margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      background: radial-gradient(1200px 700px at 10% -10%, #1b2550 0%, var(--bg) 60%);
      color: var(--text);
    }
    header{
      max-width:1200px; margin: 24px auto 12px; padding: 0 16px;
      display:flex; align-items:center; justify-content:space-between;
    }
    header h1{font-size: clamp(1.2rem, 2vw + .4rem, 2rem); margin:0; letter-spacing:.2px}
    header .tag{font-size:.9rem; color:var(--muted)}

    .grid{
      display:grid; grid-template-columns: 1.2fr .9fr .9fr; gap:16px;
      max-width:1200px; margin: 6px auto 40px; padding: 0 16px 40px;
    }
    @media (max-width: 1050px){ .grid{ grid-template-columns: 1fr; } }

    .card{
      background: linear-gradient(175deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
      border: 1px solid rgba(255,255,255,.06);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 18px;
      backdrop-filter: blur(6px);
    }
    .card h2{margin:4px 0 12px; font-size:1.15rem}
    .sub{color:var(--muted); font-size:.95rem; margin-top:-6px}

    .row{display:flex; gap:10px; flex-wrap:wrap}
    .row > *{flex:1}
    label{display:block; font-size:.9rem; color:var(--muted); margin-bottom:6px}
    input, select, button, .seg{
      background:#0f1430; color:var(--text);
      border:1px solid rgba(255,255,255,.1);
      border-radius: 12px; padding: 10px 12px; font-size: .95rem;
    }
    input[type=number]{width:120px}

    button{ cursor:pointer; transition: transform .03s ease, box-shadow .15s ease; }
    button:hover{ box-shadow: 0 6px 18px rgba(125,211,252,.18); }
    button:active{ transform: translateY(1px); }

    .btn-primary{ background: linear-gradient(120deg, var(--accent), var(--accent-2)); color:#0b0f1e; font-weight:700; border:0 }
    .btn-ghost{ background: transparent }

    .seg{ display:inline-flex; gap:6px; padding:6px; border-radius: 14px; }
    .seg input{ display:none }
    .seg label{ margin:0; padding:8px 12px; border-radius: 10px; color: var(--muted); cursor:pointer; }
    .seg input:checked + label{ background: #202955; color: var(--text); border:1px solid rgba(255,255,255,.12) }

    .payoff{ display:grid; grid-template-columns: 1fr 1fr; gap:8px; font-size:.92rem }
    .payoff .cell{ background:#0f1430; border:1px dashed rgba(255,255,255,.1); padding:10px; border-radius: 12px; text-align:center }

    .scoreboard{
      display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:8px;
    }
    .score{
      background: #0f1430; border:1px solid rgba(255,255,255,.08); padding:12px; border-radius: 12px;
    }
    .bar{height:10px; background:#1a2248; border-radius:8px; overflow:hidden; margin-top:6px}
    .bar > span{ display:block; height:100%; width:0; background: linear-gradient(90deg, var(--success), var(--accent)); transition: width .35s ease }

    .muted{ color:var(--muted); font-size:.9rem }
    .kpi{ font-size:1.4rem; font-weight:800 }

    details{ border:1px solid rgba(255,255,255,.08); border-radius:12px; padding:10px 12px; background:#0f1430 }
    details + details{ margin-top:8px }
    summary{ cursor:pointer }

    .tiny{ font-size:.78rem; color:var(--muted) }
    .warn{ color:var(--warn) }
    .danger{ color:var(--danger) }

    /* Password Gate */
    .gate{
      position:fixed; inset:0; z-index:50; display:flex; align-items:center; justify-content:center;
      background: linear-gradient(180deg, rgba(11,16,32,.9), rgba(8,12,26,.9));
      backdrop-filter: blur(10px);
    }
    .gate .box{ width:min(560px, 92vw); background: #121734; border:1px solid rgba(255,255,255,.08); border-radius: 20px; padding: 22px; box-shadow: var(--shadow) }
    .gate h3{ margin: 6px 0 4px }
    .gate .row{ align-items:flex-end }
    .shake{ animation: shake .35s ease }
    @keyframes shake{ 10%, 90%{ transform: translateX(-1px)} 20%,80%{ transform: translateX(2px)} 30%,50%,70%{ transform: translateX(-4px)} 40%,60%{ transform: translateX(4px)} }

    footer{ max-width:1200px; margin: 0 auto 40px; padding: 0 16px; color:var(--muted); font-size:.85rem }
    code.inline{ background:#0f1430; padding:2px 6px; border-radius:6px; border:1px solid rgba(255,255,255,.06) }
  </style>
</head>
<body>
  <!-- PASSWORD GATE (front-end only; for real security use server-side auth) -->
  <div id="gate" class="gate" aria-modal="true" role="dialog">
    <div class="box" id="gateBox">
      <h3>ðŸ”’ Enter Access Password</h3>
      <p class="tiny">Protected teaching module. Password is shared with participants only.</p>
      <div class="row" style="margin-top:8px">
        <div>
          <label for="pw">Password</label>
          <input id="pw" type="password" placeholder="Enter password" autocomplete="current-password" />
          <div class="tiny" style="margin-top:6px">Hint: TAES + topic + year</div>
        </div>
        <div style="flex:0 0 auto">
          <button id="unlockBtn" class="btn-primary">Unlock</button>
        </div>
      </div>
      <p class="tiny" style="margin-top:10px">Note: Frontâ€‘end password gating is a deterrent, not strong security.</p>
    </div>
  </div>

  <header>
    <h1>Oligopoly Lab</h1>
    <div class="tag">Simulation â€¢ Case Studies â€¢ Managerial Implications</div>
  </header>

  <main class="grid" aria-live="polite">
    <!-- 1) SIMULATION PANEL -->
    <section class="card" id="simPanel">
      <h2>1) Simulation Panel</h2>
      <div class="sub">Play a repeated pricing game (High Price vs Low Price). Points map to profits. A market-friction cap ensures no one can hit 100%.</div>

      <div class="row" style="margin-top:10px">
        <div>
          <label>Mode</label>
          <div class="seg" role="radiogroup" aria-label="Mode selector">
            <input type="radio" name="mode" id="modeSolo" value="solo" checked>
            <label for="modeSolo">Solo vs AI</label>
            <input type="radio" name="mode" id="modeDuo" value="duo">
            <label for="modeDuo">Twoâ€‘Player (same device)</label>
          </div>
        </div>
        <div>
          <label for="rounds">Rounds</label>
          <input id="rounds" type="number" min="3" max="50" step="1" value="10">
        </div>
        <div style="flex:0 0 auto; display:flex; gap:8px">
          <button id="startBtn" class="btn-primary">Start Game</button>
          <button id="resetBtn" class="btn-ghost">Reset</button>
        </div>
      </div>

      <div class="row" style="margin-top:4px">
        <div>
          <label>Payoff Matrix (per round)</label>
          <div class="payoff">
            <div class="cell"><strong>Both High</strong><br> A: +3 â€¢ B: +3</div>
            <div class="cell"><strong>Both Low</strong><br> A: +1 â€¢ B: +1</div>
            <div class="cell"><strong>A High, B Low</strong><br> A: +0 â€¢ B: +5</div>
            <div class="cell"><strong>A Low, B High</strong><br> A: +5 â€¢ B: +0</div>
          </div>
          <div class="tiny" style="margin-top:6px">Max perâ€‘round points for a player = 5. Percentage scores are scaled and capped at <strong>95%</strong> to model market frictions.</div>
        </div>
      </div>

      <div id="playArea" style="margin-top:12px; display:none">
        <div class="row">
          <div>
            <label>Round</label>
            <div class="kpi" id="roundLabel">â€“</div>
          </div>
          <div>
            <label>Friction Cap</label>
            <div class="kpi">95% <span class="tiny">(no perfect scores)</span></div>
          </div>
          <div>
            <label>AI Strategy (Solo mode)</label>
            <select id="aiStyle">
              <option value="tft">Titâ€‘forâ€‘Tat (with 10% noise)</option>
              <option value="alwaysHigh">Always High</option>
              <option value="alwaysLow">Always Low</option>
              <option value="random">Random</option>
            </select>
          </div>
        </div>

        <div class="row" style="margin-top:10px" id="controlsSolo">
          <div>
            <label>Player A Choice</label>
            <div class="seg">
              <input type="radio" name="aChoice" id="aHigh" value="H" checked>
              <label for="aHigh">High Price</label>
              <input type="radio" name="aChoice" id="aLow" value="L">
              <label for="aLow">Low Price</label>
            </div>
          </div>
          <div style="flex:0 0 auto; display:flex; align-items:flex-end">
            <button id="playRoundBtn" class="btn-primary">Play Round</button>
          </div>
        </div>

        <div class="row" style="margin-top:10px; display:none" id="controlsDuo">
          <div>
            <label>Player A Choice</label>
            <div class="seg">
              <input type="radio" name="aChoice2" id="aHigh2" value="H" checked>
              <label for="aHigh2">High Price</label>
              <input type="radio" name="aChoice2" id="aLow2" value="L">
              <label for="aLow2">Low Price</label>
            </div>
          </div>
          <div>
            <label>Player B Choice</label>
            <div class="seg">
              <input type="radio" name="bChoice2" id="bHigh2" value="H" checked>
              <label for="bHigh2">High Price</label>
              <input type="radio" name="bChoice2" id="bLow2" value="L">
              <label for="bLow2">Low Price</label>
            </div>
          </div>
          <div style="flex:0 0 auto; display:flex; align-items:flex-end">
            <button id="resolveBtn" class="btn-primary">Resolve Round</button>
          </div>
        </div>

        <div class="scoreboard">
          <div class="score" id="scoreA">
            <div><strong>Player A</strong></div>
            <div>Total Points: <span id="pointsA">0</span></div>
            <div>Score % (frictionâ€‘capped): <span id="pctA">0</span>%</div>
            <div class="bar"><span id="barA" style="width:0%"></span></div>
            <div class="tiny">Collusion Index (share of High choices): <span id="collA">0.00</span></div>
            <div class="tiny">Assessment: <span id="assessA">â€“</span></div>
          </div>
          <div class="score" id="scoreB">
            <div><strong>Player B</strong></div>
            <div>Total Points: <span id="pointsB">0</span></div>
            <div>Score % (frictionâ€‘capped): <span id="pctB">0</span>%</div>
            <div class="bar"><span id="barB" style="width:0%"></span></div>
            <div class="tiny">Collusion Index (share of High choices): <span id="collB">0.00</span></div>
            <div class="tiny">Assessment: <span id="assessB">â€“</span></div>
          </div>
        </div>

        <div style="margin-top:10px">
          <label for="log">Round Log</label>
          <div id="log" style="max-height:160px; overflow:auto; background:#0f1430; border:1px solid rgba(255,255,255,.08); border-radius:12px; padding:10px; font-size:.92rem"></div>
        </div>

        <div style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap">
          <button id="exportBtn" class="btn-ghost">Export CSV</button>
          <div class="tiny">CSV includes roundâ€‘byâ€‘round choices & payoffs.</div>
        </div>
      </div>
    </section>

    <!-- 2) CASE STUDIES -->
    <section class="card" id="caseStudies">
      <h2>2) Case Studies</h2>
      <div class="sub">Compact, classroomâ€‘ready capsules. Use them for discussion prompts after running the game.</div>

      <details>
        <summary><strong>OPECâ€™s Production Coordination</strong> â€” price leadership in a global commodity</summary>
        <div class="muted" style="margin-top:8px">
          Organization of Petroleum Exporting Countries often acts as a focal point for coordinated output decisions. Production quotas resemble a collusive outcome, while nonâ€‘OPEC supply and demand shocks introduce instability. Discuss incentive to defect (overâ€‘produce) vs reputational punishments (future quota cuts).
        </div>
      </details>

      <details>
        <summary><strong>Airline Fare Wars</strong> â€” Bertrand dynamics with capacity constraints</summary>
        <div class="muted" style="margin-top:8px">
          On competitive routes, airlines may cut prices (low) to fill seats, triggering cascades. When capacity is constrained or differentiated, tacit coordination emerges via advanceâ€‘purchase restrictions and priceâ€‘match policies. Explore how transparency (fare search engines) affects undercutting.
        </div>
      </details>

      <details>
        <summary><strong>Smartphone Platforms</strong> â€” multiâ€‘sided oligopoly</summary>
        <div class="muted" style="margin-top:8px">
          A few platforms set rules for developers and users. Pricing bundles (devices, app store fees, ads) create crossâ€‘group spillovers. Study how vertical integration and ecosystem lockâ€‘in alter payoff matrices relative to simple price games.
        </div>
      </details>

      <details>
        <summary><strong>Cement Markets</strong> â€” repeated interactions & investigations</summary>
        <div class="muted" style="margin-top:8px">
          Homogeneous product, repeated bids, and observable capacity create fertile ground for tacit or explicit coordination. Regulatory scrutiny focuses on parallel pricing and exchange of sensitive information.
        </div>
      </details>

    </section>

    <!-- 3) MANAGERIAL IMPLICATIONS -->
    <section class="card" id="implications">
      <h2>3) Managerial Implications</h2>
      <div class="sub">Translate game outcomes into strategy and compliance.
      </div>

      <ul>
        <li><strong>Trigger strategies</strong>: A oneâ€‘time undercut can collapse margins for many rounds. Map your tolerance for defection before competitive moves.</li>
        <li><strong>Capacity & commitment</strong>: Credible capacity expansions shift payoffs toward aggressive pricing; preâ€‘commitments can deter rivals.</li>
        <li><strong>Differentiation</strong>: Reduce headâ€‘toâ€‘head Bertrand spirals by adding features, service, or bundlesâ€”changing the payoff table.</li>
        <li><strong>Information policy</strong>: Public price signaling or sharing competitively sensitive data can create legal exposureâ€”build internal compliance guardrails.</li>
        <li><strong>Regulator lens</strong>: Stable high prices with frequent contact among rivals risks inference of coordination. Document independent decision processes.</li>
        <li><strong>Experimentation</strong>: Run A/B style market tests with geoâ€‘fencing to infer rival response functions safely.</li>
      </ul>
      <p class="tiny warn">Pedagogical note: This module models incentives, not legal advice. Always consult your competitionâ€‘law counsel.</p>
    </section>
  </main>

  <footer>
    Built for classroom use. Payoff cap implemented via a 5% friction factor so a perfect 100% is unattainable by design. You can tweak it in <code class="inline">FRICTION</code> inside the script.
  </footer>

  <script>
    // ===============================
    // Password Gate (frontâ€‘end)
    // ===============================
    // Precomputed SHAâ€‘256 of the accepted password string.
    // Password (for instructors): TAES-oligopoly-2025
    // Hash generated via crypto: 3dac5af7c5520121269c861536c6815727f161072f4289f13f0c25268636a75b
    const PASS_HASH = '3dac5af7c5520121269c861536c6815727f161072f4289f13f0c25268636a75b';

    async function sha256Hex(str){
      const buf = new TextEncoder().encode(str);
      const digest = await crypto.subtle.digest('SHA-256', buf);
      const bytes = new Uint8Array(digest);
      return Array.from(bytes).map(b=>b.toString(16).padStart(2,'0')).join('');
    }

    async function tryUnlock(){
      const box = document.getElementById('gateBox');
      const pw = document.getElementById('pw').value || '';
      const hex = await sha256Hex(pw);
      if(hex === PASS_HASH){
        sessionStorage.setItem('oligo_gate','ok');
        document.getElementById('gate').style.display='none';
        setTimeout(()=>document.getElementById('pw').value='', 50);
      } else {
        box.classList.remove('shake'); box.offsetWidth; box.classList.add('shake');
      }
    }

    (function initGate(){
      const saved = sessionStorage.getItem('oligo_gate');
      if(saved==='ok'){ document.getElementById('gate').style.display='none'; }
      document.getElementById('unlockBtn').addEventListener('click', tryUnlock);
      document.getElementById('pw').addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ tryUnlock(); }});
    })();

    // ===============================
    // Simulation Logic
    // ===============================
    const MAX_PER_ROUND = 5;               // maximum points a player can earn in a round
    const FRICTION = 0.95;                 // 95% cap: ensures nobody reaches 100%
    const NOISE = 0.10;                    // AI noise level for Titâ€‘forâ€‘Tat

    // State
    let mode = 'solo';
    let totalRounds = 10;
    let round = 0;
    let aPoints = 0; let bPoints = 0;
    let aHighCount = 0; let bHighCount = 0;
    let lastA='H', lastB='H';
    let logRows = [];

    // DOM helpers
    const $ = sel => document.querySelector(sel);
    const logEl = $('#log');

    function reset(){
      round = 0; aPoints = 0; bPoints = 0; aHighCount=0; bHighCount=0; lastA='H'; lastB='H'; logRows=[];
      $('#roundLabel').textContent = 'â€“';
      $('#pointsA').textContent = '0'; $('#pointsB').textContent='0';
      $('#pctA').textContent='0'; $('#pctB').textContent='0';
      $('#barA').style.width='0%'; $('#barB').style.width='0%';
      $('#collA').textContent='0.00'; $('#collB').textContent='0.00';
      $('#assessA').textContent='â€“'; $('#assessB').textContent='â€“';
      logEl.innerHTML='';
    }

    function start(){
      reset();
      totalRounds = Math.max(3, Math.min(50, parseInt($('#rounds').value || '10')));
      $('#playArea').style.display='block';
      mode = document.querySelector('input[name="mode"]:checked').value;
      $('#controlsSolo').style.display = (mode==='solo') ? 'flex' : 'none';
      $('#controlsDuo').style.display = (mode==='duo') ? 'flex' : 'none';
      round = 1; updateRoundLabel();
      appendLog(`Game started â€¢ Mode: ${mode==='solo'?'Solo vs AI':'Twoâ€‘Player'} â€¢ Rounds: ${totalRounds}`);
    }

    function updateRoundLabel(){ $('#roundLabel').textContent = `${round} / ${totalRounds}`; }

    function appendLog(text){
      const p = document.createElement('div'); p.textContent = `R${round}: ${text}`; logEl.appendChild(p); logEl.scrollTop = logEl.scrollHeight;
      logRows.push({r: round, text});
    }

    function payoff(a, b){
      // returns [aPoints, bPoints]
      if(a==='H' && b==='H') return [3,3];
      if(a==='L' && b==='L') return [1,1];
      if(a==='H' && b==='L') return [0,5];
      if(a==='L' && b==='H') return [5,0];
      return [0,0];
    }

    function assess(coll){
      if(coll>=0.8) return 'Strongly collusive';
      if(coll>=0.5) return 'Mixed / tacit coordination';
      if(coll>=0.25) return 'Moderate competition';
      return 'Aggressive competition';
    }

    function pct(points){
      // percent with friction cap (cannot reach 100)
      if(round<=0) return 0;
      const raw = (points / (MAX_PER_ROUND * round)) * 100;
      return Math.min( Math.round(raw * FRICTION), 99 );
    }

    function updateScores(){
      const pA = pct(aPoints), pB = pct(bPoints);
      $('#pointsA').textContent = aPoints; $('#pointsB').textContent = bPoints;
      $('#pctA').textContent = pA; $('#pctB').textContent = pB;
      $('#barA').style.width = pA + '%'; $('#barB').style.width = pB + '%';
      const cA = (round? (aHighCount/round):0).toFixed(2), cB = (round? (bHighCount/round):0).toFixed(2);
      $('#collA').textContent = cA; $('#collB').textContent = cB;
      $('#assessA').textContent = assess(parseFloat(cA));
      $('#assessB').textContent = assess(parseFloat(cB));
    }

    function nextRound(){
      if(round < totalRounds){ round++; updateRoundLabel(); }
      else { appendLog('Game over. Review scores & export CSV.'); }
    }

    function aiChoice(){
      const style = $('#aiStyle').value;
      if(style==='alwaysHigh') return 'H';
      if(style==='alwaysLow') return 'L';
      if(style==='random') return Math.random()<0.5 ? 'H' : 'L';
      // Titâ€‘forâ€‘Tat with noise: mirror opponent's last move; occasionally flip
      let c = lastA; // mirror A's last move
      if(Math.random() < NOISE) c = (c==='H'?'L':'H');
      return c;
    }

    function resolve(a, b){
      const [pa, pb] = payoff(a,b);
      aPoints += pa; bPoints += pb;
      if(a==='H') aHighCount++; if(b==='H') bHighCount++;
      appendLog(`A chose ${a==='H'?'High':'Low'}; B chose ${b==='H'?'High':'Low'} â†’ Î”A:${pa}, Î”B:${pb}`);
      lastA = a; lastB = b;
      updateScores();
      nextRound();
    }

    // Solo play handler
    function playSolo(){
      if(round>totalRounds){ return; }
      const a = document.querySelector('input[name="aChoice"]:checked').value;
      const b = aiChoice();
      resolve(a,b);
    }

    // Duo play handler
    function playDuo(){
      if(round>totalRounds){ return; }
      const a = document.querySelector('input[name="aChoice2"]:checked').value;
      const b = document.querySelector('input[name="bChoice2"]:checked').value;
      resolve(a,b);
    }

    function exportCSV(){
      let csv = 'round,a_choice,b_choice,a_delta,b_delta,a_total,b_total\n';
      // reconstruct deltas via payoff of stored last moves in logRows
      let aT=0, bT=0;
      for(let i=0;i<logRows.length;i++){
        const t = logRows[i].text;
        const m = /A chose (High|Low); B chose (High|Low) â†’ Î”A:(\-?\d+), Î”B:(\-?\d+)/.exec(t);
        if(!m) continue;
        const aC = (m[1]==='High'?'H':'L');
        const bC = (m[2]==='High'?'H':'L');
        const aD = parseInt(m[3]);
        const bD = parseInt(m[4]);
        aT += aD; bT += bD;
        csv += `${i+1},${aC},${bC},${aD},${bD},${aT},${bT}\n`;
      }
      const blob = new Blob([csv], {type:'text/csv'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'oligopoly_simulation_results.csv';
      document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
    }

    // Events
    (function init(){
      $('#startBtn').addEventListener('click', start);
      $('#resetBtn').addEventListener('click', reset);
      $('#playRoundBtn').addEventListener('click', playSolo);
      $('#resolveBtn').addEventListener('click', playDuo);
      $('#exportBtn').addEventListener('click', exportCSV);
      document.querySelectorAll('input[name="mode"]').forEach(r => r.addEventListener('change', (e)=>{
        mode = e.target.value;
        $('#controlsSolo').style.display = (mode==='solo') ? 'flex' : 'none';
        $('#controlsDuo').style.display = (mode==='duo') ? 'flex' : 'none';
      }));
    })();
  </script>
</body>
</html>
